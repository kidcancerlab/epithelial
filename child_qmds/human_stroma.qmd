# Set up automated cell type annotation

```{r}
lung_ref <- qs::qread("LungRefs/normal_lung.qs")
lung_ref$free_annotation <-
    str_replace_all(lung_ref$free_annotation,
        c("/" = "_", "\\+" = "_plus"))
lung_ref$free_annotation <-
    stringr::str_replace_all(lung_ref$free_annotation,
        c("Alveolar Epithelial Type 1" = "Alveolar Epithelial",  #nolint
            "Alveolar Epithelial Type 2" = "Alveolar Epithelial",  #nolint
            "Basophil_Mast 1" = "Basophil_Mast",
            "Basophil_Mast 2" = "Basophil_Mast",
            "Bronchial Vessel 1" = "Bronchial Vessel",
            "Bronchial Vessel 2" = "Bronchial Vessel",
            "IGSF21_plus Dendritic" = "Dendritic cells",
            "Myeloid Dendritic Type 1" = "Myeloid Dendritic",   #nolint
            "Myeloid Dendritic Type 2" = "Myeloid Dendritic",   #nolint
            "Natural Killer" = "NK cells",
            "Natural Killer T" = "NKT",
            "NK cells T" = "NKT",
            "CD4_plus Memory/Effector T" = "CD4+ T cells",
            "CD4_plus Naive T" = "CD4+ T cells",
            "CD8_plus Memory_Effector T" = "CD8+ T cells",
            "CD8_plus Naive T" = "CD8+ T cells",
            "Proliferating NK_T" = "NKT",
            "TREM2_plus Dendritic" = "Dendritic cells",
            "Proliferating Macrophage" = "Macrophage",
            "Nonclassical Monocyte" = "Monocytes",
            "Classical Monocyte" = "Monocytes"))

annotate <- function(sobject,
    aggr_ref = FALSE,
    label_type = "label.main",
    ...) {
        hpca <- celldex::HumanPrimaryCellAtlasData()
        hpca$label.main <-
            stringr::str_replace_all(hpca$label.main,
                c("T_cells" = "T cells",
                "B_cell" = "B cells",
                "NK_cell" = "NK cells",
                "Monocyte" = "Monocytes",
                "DC" = "Dendritic cells"))
        huim <- celldex::MonacoImmuneData()
        ref3 <- GetAssayData(lung_ref)
        ref <- list(hpca, huim, ref3)
        labels <- list(
            hpca[[label_type]],
            huim[[label_type]],
            lung_ref$free_annotation)
        annotation <-
            SingleR::SingleR(test = Seurat::as.SingleCellExperiment(sobject),
                ref = ref,
                labels = labels,
                aggr.ref = aggr_ref,
                ...)
        sobject$annotations <- annotation$labels
        sobject$cell_scores <-
            apply(X = annotation$scores,
                MARGIN = 1,
                function(x) max(x, na.rm = TRUE))
        return(sobject)
    }
```

# Load the normal human lung data
GSE227136 contains a very large control normal lung dataset. We will extract normal lung scRNA-seq from this.

The download will contain all of the lung sets (diseased and normal). We will keep only the healthy lung samples processed at TGen--these were not sorted like those processed at Vanderbilt, so match our datasets better. We will also keep only the never-smokers. This reduces our sample to the following list of sample names: THD0002, THD0006, THD0010, THD0014, VUHD69, VUHD076.

NOTE: If you haven't already downloaded and processed, you might need to run this step on a himem node.

```{r}
# Check to see if we've already downloaded and processed normal lung
# from https://doi.org/10.15252/embj.20105114
if(!file.exists("output/rdata/normal_lung.qs")) {
    # Download the files
    if(!dir.exists("Lukassen")) {
        dir.create("Lukassen")
    }

    if(!file.exists("Lukassen/counts.csv")) {
        options(timeout = 1800)
        download.file("https://figshare.com/ndownloader/files/21999237",
            destfile = "Lukassen/counts.csv")
        download.file("https://figshare.com/ndownloader/files/21999240",
            destfile = "Lukassen/metadata.csv")
    }

    # Isolate the normal lung datasets
    c <- data.table::fread("Lukassen/counts.csv") %>%
        data.frame(row.names = 1)
    m <- read.csv("Lukassen/metadata.csv") %>%
        rename(id = ID,
            sex = Sex,
            age = Age,
            smoking = Smoking,
            cell_type = Cell.type,
            percent.mt = MT.ratio,
            nFeature_RNA = Gene.count,
            nCount_RNA = UMI.count) %>%
            mutate(src = "Lukassen",
                method = "nucleus",
                type = "Healthy")
    colnames(c) <- rownames(m)
    normal_lung <- CreateSeuratObject(counts = c, assay = "RNA", meta.data = m) %>%
        NormalizeData() %>%
        SplitObject(split.by = "id")

    qs::qsave(normal_lung, "output/rdata/normal_lung.qs")

} else {

    normal_lung <- qs::qread("output/rdata/normal_lung.qs")

}
```

# Load the osteosarcoma lung metastases

```{r}
if(!file.exists("output/rdata/met_lungs.qs")) {
    if(!dir.exists("GSE152048")) {
        dir.create("GSE152048")
    }

    if(!dir.exists("GSE152048/BC10")) {
        dir.create("GSE152048/BC10")
        download.file("https://ftp.ncbi.nlm.nih.gov/geo/series/GSE152nnn/GSE152048/suppl/GSE152048%5FBC10.matrix.tar.gz",
            destfile = "GSE152048/BC10/matrix.tar.gz")
        untar("GSE152048/BC10/matrix.tar.gz",
            exdir = "GSE152048",
            extras = "--remove-files")
    }

    if(!dir.exists("GSE152048/BC17")) {
        dir.create("GSE152048/BC17")
        download.file("https://ftp.ncbi.nlm.nih.gov/geo/series/GSE152nnn/GSE152048/suppl/GSE152048%5FBC17.matrix.tar.gz",
            destfile = "GSE152048/BC17/matrix.tar.gz")
        untar("GSE152048/BC17/matrix.tar.gz",
            exdir = "GSE152048",
            extras = "--remove-files")
    }
}

mets_meta <- tribble(
    ~file, ~Sample_Name, ~Sample_Source, ~Sample_Type, ~method,
    "/gpfs0/home2/gdrobertslab/lab/Counts/S0217/filtered_feature_bc_matrix", "S0217", "Roberts Lab", "Metastasis", "nucleus",
    "/gpfs0/home2/gdrobertslab/lab/Counts/S0218/filtered_feature_bc_matrix", "S0218", "Roberts Lab", "Metastasis", "nucleus",
    "/gpfs0/home2/gdrobertslab/lab/Counts/SC069/filtered_feature_bc_matrix/", "SC069", "Roberts Lab", "Metastasis", "nucleus",
    "/gpfs0/home2/gdrobertslab/lab/Counts/SC072/filtered_feature_bc_matrix/", "SC072", "Roberts Lab", "Metastasis", "nucleus",
    "/gpfs0/home2/gdrobertslab/lab/Counts/SC073/filtered_feature_bc_matrix/", "SC073", "Roberts Lab", "Metastasis", "nucleus")

met_lung <- mclapply(1:nrow(mets_meta),
    function(m) {
        message(paste("Starting to load", mets_meta$Sample_Name[m], "..."))
        s <- tenx_load_qc(mets_meta$file[m], violin_plot = FALSE) %>%
            NormalizeData()
        s$id <- mets_meta$Sample_Name[m]
        s$src <- mets_meta$Sample_Source[m]
        s$type <- mets_meta$Sample_Type[m]
        s$method <- mets_meta$method[m]
        message(paste(mets_meta$Sample_Name[m], "completed."))
        return(s)
    }, mc.cores = parallelly::availableCores())
names(met_lung) <- mets_meta$Sample_Name
```

# Find and exclude tumor cells from met samples

NOTE: if tumor cells have not been previously assigned for any of the samples, this script will error out with a message to run that code and create those samples before proceding.
```{r}
if(!file.exists("output/rdata/met_lung_annotated.qs")) {
    met_lung <- mclapply(seq_along(met_lung), function(s) {
        message(paste("Starting sample", names(met_lung)[s], "..."))
        o <- process_seurat(met_lung[[s]]) %>%
            annotate()
        return(o)
        message(paste("Completed", names(met_lung)[s], "."))
    }, mc.cores = parallelly::availableCores())
    names(met_lung) <- mets_meta$Sample_Name

    qs::qsave(met_lung, "output/rdata/met_lung_annotated.qs")
} else {
    met_lung <- qs::qread("output/rdata/met_lung_annotated.qs")
}

# Check to see if all of the relevant annotation files are present
file_check <- TRUE
for(f in names(met_lung)) {
    if(!file.exists(paste0("misc/", f, "-tumor_assignments.qs"))) {
        file_check <- FALSE
        stop("At least some of the tumor assignment files are missing. You will need to run the code process in this file manually before proceding to create those files.")
    }
}

# Skip this code if all files are present, otherwise will need to
# be run manually to produce the annotation files
if(!file_check) {
    plots <- lapply(seq_along(met_lung), function(i) {
        p1 <- r_dim_plot(met_lung[[i]], names(met_lung)[i])
        p2 <- r_feature_plot(met_lung[[i]], "cell_scores")
        p3 <- r_feature_plot(met_lung[[i]], "COL1A1")
        p4 <- r_feature_plot(met_lung[[i]], "SPP1")
        p5 <- r_feature_plot(met_lung[[i]], "nCount_RNA")
        p6 <- DimPlot(met_lung[[i]], label = TRUE, group.by = "annotations") +
            theme(legend.position = "none") +
            coord_fixed()
        p <- (p1 | p6 | p2) / (p3 | p4 | p5)
        return(p)
    })

    # Code for manual curation. Designed for interactive review of plots.
    i = 5
    met_lung[[i]]$tumor <- "stroma"
    plots[[i]]

    gt::gt(met_lung[[i]]@meta.data %>%
        select(annotations, seurat_clusters) %>%
        group_by(seurat_clusters, annotations) %>%
        summarise(n = n()) %>%
        arrange(seurat_clusters, -n))

    # Use this code, changing cluster numbers, to designate tumor cells.
    met_lung[[i]]$tumor[met_lung[[i]]$seurat_clusters == 5] <- "tumor"

    # Check result of tumor designation and save a list of tumor assignments.
    r_dim_plot(met_lung[[i]], "Tumor vs. Stroma", group.by = "tumor")
    qs::qsave(met_lung[[i]]$tumor,
        paste0("misc/", names(met_lung)[i], "-tumor_assignments.qs"))
}

# Separate the tumor cells from the lung stroma
met_stroma <- lapply(seq_along(met_lung), function (i) {
    met_lung[[i]]$tumor <- qs::qread(file = paste0(
        "misc/",
        names(met_lung)[i],
        "-tumor_assignments.qs"))
    s <- subset(met_lung[[i]], tumor == "stroma")
    return(s)
})
names(met_stroma) <- names(met_lung)
```

# Combine datasets from normal and met

Need to rewrite to make integration conditional on having been previously run***
```{r}
    # Check to see if integrated dataset has already been processed
if(!file.exists("output/rdata/integrated_lungs.qs")) {
    # Merge the normal and metastatic lung data into a single object
    # Downsample the normal lung data
    for(i in seq_along(normal_lung)) {
        normal_lung[[i]] <- subset(normal_lung[[i]], downsample = 1000)
    }

    param <- BiocParallel::MulticoreParam(workers = parallelly::availableCores() - 1)

    lungs <- merge(normal_lung[[1]],
            c(normal_lung[2:length(normal_lung)], met_stroma),
            add.cell.ids = c(names(normal_lung), names(met_stroma))) %>%
        ScaleData() %>%
        FindVariableFeatures() %>%
        RunPCA(npcs = 30, verbose = FALSE) %>%
        harmony::RunHarmony(group.by.vars = c("id")) %>%
        RunUMAP(reduction = "harmony", dims = 1:30) %>%
        FindNeighbors(reduction = "umap", dims = 1:2) %>%
        FindClusters(resolution = 0.2)

        qs::qsave(lungs, "output/rdata/integrated_lungs.qs")
} else {
    lungs <- qs::qread("output/rdata/integrated_lungs.qs")
}

p1 <- r_dim_plot(subset(lungs, type == "Healthy"),
    group.by = "cell_type",
    shuffle = TRUE)
p2 <- DimPlot(subset(lungs, type == "Metastasis"),
    group.by = "annotations",
    label = TRUE,
    shuffle = TRUE) +
    theme(legend.position = "none") +
    coord_fixed()
p3 <- r_dim_plot(lungs, "Integrated Stroma")
p1 | p2 | p3

# Perform a semi-automated, manually verified cell type assignment
if(!file.exists("misc/lungs_manual_assignment.qs")) {
    lungs <- annotate(lungs, BPPARAM = param)

    gt::gt(lungs@meta.data %>%
        mutate(integrated = coalesce(annotations, cell_type)) %>%
        select(seurat_clusters, integrated) %>%
        group_by(seurat_clusters, integrated) %>%
        summarise(n = n()) %>%
        arrange(seurat_clusters, -n))

    lungs <- RenameIdents(lungs,
        `0` = "Alveolar Epithelial",
        `1` = "Alveolar Epithelial",
        `2` = "Tumor Carryover",
        `3` = "Alveolar Epithelial",
        `4` = "Monocyte",
        `5` = "Endothelial",
        `6` = "Macrophage",
        `7` = "Alveolar Epithelial",
        `8` = "Alveolar Epithelial",
        `9` = "Ciliated",
        `10` = "Macrophage",
        `11` = "Fibroblast",
        `12` = "Macrophage",
        `13` = "Monocyte",
        `14` = "Endothelial",
        `15` = "Club",
        `16` = "Dendritic",
        `17` = "T/NK")

    lungs$manual_assignments <- Idents(lungs)
    qs::qsave(lungs$manual_assignments, "misc/lungs_manual_assignment.qs")
} else {
    lungs$manual_assignments <- qs::qread("misc/lungs_manual_assignment.qs")
}

r_dim_plot(lungs, "Manual Assignments", group.by = "manual_assignments")
r_dim_plot(lungs, "Manual Assignments", group.by = "manual_assignments", split.by = "type")
<<<<<<< HEAD
=======
r_feature_plot(lungs, "KRT8")
>>>>>>> 663c874 (updated through epithelial subclustering)
```

# Subcluster epithelial cells

```{r}
epi <- subset(lungs, manual_assignments == "Alveolar Epithelial")
epi <- DietSeurat(epi, assays = "RNA") %>%
    FindVariableFeatures() %>%
    ScaleData() %>%
    RunPCA(npcs = 20, verbose = FALSE) %>%
    harmony::RunHarmony(group.by.vars = c("id", "type"), lambda = c(1, 1)) %>%
    RunUMAP(reduction = "harmony", dims = 1:20) %>%
    FindNeighbors(reduction = "harmony") %>%
    FindClusters(resolution = 0.2)

epi <- kill_cc(epi)

<<<<<<< HEAD
qs::qsave(epi, "output/rdata/human_epithelial.qs")

=======
>>>>>>> 663c874 (updated through epithelial subclustering)
p1 <- r_dim_plot(epi, "Distal Airway - Cell Cycle",
    group.by = "Phase", label = FALSE) +
    ggtitle("Distal Airway - Phase") +
    theme(legend.position = "right")
p2 <- r_dim_plot(subset(epi, type == "Healthy"),
    group.by = "seurat_clusters") +
    ggtitle("Distal Airway - Healthy")
p3 <- r_dim_plot(subset(epi, type == "Metastasis"),
    group.by = "seurat_clusters") +
    ggtitle("Distal Airway - Metastasis")
p4 <- r_feature_plot(epi, "KRT8")
p5 <- r_feature_plot(epi, "SFTPC")
p6 <- r_feature_plot(epi, "PDPN")
(p1 | p2 | p3) / (p4 | p5 | p6)
<<<<<<< HEAD

Idents(epi) <- epi$seurat_clusters
epi_marks <- FindAllMarkers(epi)

gt::gt(epi_marks %>%
    group_by(cluster) %>%
    slice_max(abs(avg_log2FC), n = 16) %>%
    arrange(cluster, -avg_log2FC))

r_feature_plot(epi, "KRT17")
=======
>>>>>>> 663c874 (updated through epithelial subclustering)
```